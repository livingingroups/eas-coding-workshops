library(tinytest)

# these two lines set the working directory to the directory that "run_test_file" is called from
# not needed if that's the same as the directory this file is in
tt_call_wd <- get_call_wd()
if(tt_call_wd != '') setwd(tt_call_wd)

source('./03-three-file-workflow/spatial_enso_lomas_lib.R')

# Define input data ----

# subset to year 2015

sample_group_data <- data.frame(
  X = c(20L, 28L, 52L, 69L, 91L, 120L),
  id = c("aa_2015", "ce_2015", "ff_2015", "fl_2015", "nm_2015", "rr_2015"),
  DOF = c(42.1272797887948, 15.6010147857965, 16.9838846590234, 25.6636516309937, 9.83374158795608, 14.120254441294),
  low = c(1.75816332436552, 0.435508876011684, 1.18808543580871, 2.25042366457417, 0.961612938582414, 0.779695644350222),
  area = c(2.4381735406197, 0.76814542535554, 2.04009674084268, 3.45569079077514, 2.02006028540803, 1.42193621651821),
  high = c(3.22763057016738, 1.19361190616709, 3.11866748557699, 4.91530747480975, 3.46468842604013, 2.25394075953317),
  scale = c(0.0578763583322609, 0.0492368884910535, 0.120119559323478, 0.134653121093716, 0.205421330969496, 0.100701883413646),
  rate = c(17.2782121891485, 20.3099755213351, 8.32503886654322, 7.4264895746755, 4.8680436217624, 9.93030086530126),
  shape = c(42.1272797887948, 15.6010147857965, 16.9838846590234, 25.6636516309937, 9.83374158795608, 14.120254441294),
  group = c("aa", "ce", "ff", "fl", "nm", "rr"),
  year = 2015,
  group_size = c(25L, 16L, 16L, 21L, 13L, 23L),
  group_index = c(1L, 2L, 5L, 6L, 8L, 10L),
  group_size_std = c(0.467743753509256, -0.727147494538406, -0.727147494538406, -0.063319023400816, -1.12544457722096, 0.20221236505422)
)

sample_mei_data <- tibble(
  year = 2015,
  month = as.factor(c("DJ", "JF", "FM", "MA", "AM", "MJ", "JJ", "JA", "AS", "SO", "ON", "ND")),
  date = as.factor(c("2015-01-01", "2015-02-01", "2015-03-01", "2015-04-01", "2015-05-01", 
           "2015-06-01", "2015-07-01", "2015-08-01", "2015-09-01", "2015-10-01", 
           "2015-11-01", "2015-12-01")),
  mei = c(0.23, 0.06, 0.15, 0.31, 0.95, 1.9, 1.79, 1.95, 2.24, 2.15, 1.94, 1.93),
  phase = as.factor(c("Neutral Phase", "Neutral Phase", "Neutral Phase", "Neutral Phase", 
                      "Warm Phase/El Nino", "Warm Phase/El Nino", "Warm Phase/El Nino", 
                      "Warm Phase/El Nino", "Warm Phase/El Nino", "Warm Phase/El Nino", 
                      "Warm Phase/El Nino", "Warm Phase/El Nino")),
  phase_index = c(2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L)
)

sample_riparian_data <- data.frame(
  X = c(60L, 68L, 81L, 91L, 106L, 121L),
  id = c("aa_2015", "ce_2015", "ff_2015", "fl_2015", "nm_2015", "rr_2015"),
  group = c("aa", "ce", "ff", "fl", "nm", "rr"),
  year = c(2015L, 2015L, 2015L, 2015L, 2015L, 2015L),
  hr_area = c(2861261.53725267, 592104.157376666, 2579024.05136139, 5623448.71456679, 2730719.41022576, 2037915.79610467),
  intersect_area = c(864509.967807184, 255597.313956759, 505717.263935968, 1486764.32596561, 390727.692921924, 652124.038316139),
  prop_river = c(0.302142938194063, 0.43167626974482, 0.19608861874282, 0.264386571556054, 0.143085990987855, 0.319995575657556),
  mean_mei = c(1.27083333333333, 1.27083333333333, 1.27083333333333, 1.27083333333333, 1.27083333333333, 1.27083333333333),
  median_mei = c(1.7, 1.7, 1.7, 1.7, 1.7, 1.7),
  group_index = c(1L, 2L, 5L, 6L, 8L, 10L)
)

# Define expected output----

expected_riparian_list <- list(
  hr_area = c(2861262, 592104, 2579024, 5623449, 2730719, 2037916),
  intersect_area = c(864510, 255597, 505717, 1486764, 390728, 652124),
  prop_river = c( 0.302142938194063, 0.43167626974482, 0.19608861874282, 0.264386571556054, 0.143085990987855, 0.319995575657556 ),
  group_index = c(1L, 2L, 5L, 6L, 8L, 10L),
  year_index = c(1L, 1L, 1L, 1L, 1L, 1L),
  year = c(2015L, 2015L, 2015L, 2015L, 2015L, 2015L),
  mei = c(0.23, 0.06, 0.15, 0.31, 0.95, 1.9, 1.79, 1.95, 2.24, 2.15, 1.94, 1.93),
  year_index_mei = c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L),
  N_years = 1L,
  N = 6L,
  N_groups = 6L,
  group_size_std = c( 0.467743753509256, -0.727147494538406,-0.727147494538406, -0.063319023400816, -1.12544457722096, 0.20221236505422 ),
  group_size = c(25L, 16L, 16L, 21L, 13L, 23L)
)

expected_area_list <- list(
  hr_area_mean = c( 2.4381735406197, 0.76814542535554, 2.04009674084268, 3.45569079077514, 2.02006028540803, 1.42193621651821 ),
  hr_area_high = c( 3.22763057016738, 1.19361190616709, 3.11866748557699, 4.91530747480975, 3.46468842604013, 2.25394075953317 ),
  hr_area_low = c( 1.75816332436552, 0.435508876011684, 1.18808543580871, 2.25042366457417, 0.961612938582414, 0.779695644350222 ),
  hr_area_rate = c( 17.2782121891485, 20.3099755213351, 8.32503886654322, 7.4264895746755, 4.8680436217624, 9.93030086530126 ),
  hr_area_shape = c( 42.1272797887948, 15.6010147857965, 16.9838846590234, 25.6636516309937, 9.83374158795608, 14.120254441294 ),
  group_index = 1:6,
  group_size = c(25L, 16L, 16L, 21L, 13L, 23L),
  group_size_std = structure(
    c( 1.27920429813366,-0.639602149066831, -0.639602149066831, 0.426401432711221, -1.27920429813366, 0.852802865422442 ),
    "scaled:center" = 19,
    "scaled:scale" = 4.69041575982343
  ),
  log_group_size = c( 3.2188758248682, 2.77258872223978, 2.77258872223978, 3.04452243772342, 2.56494935746154, 3.13549421592915 ),
  year_index = c(1L, 1L, 1L, 1L, 1L, 1L),
  mei = c(0.23, 0.06, 0.15, 0.31, 0.95, 1.9, 1.79, 1.95, 2.24, 2.15, 1.94, 1.93),
  year_mei = rep(2015, 12),
  year_index_mei = rep(1, 12),
  N_years = 1L,
  N = 6L,
  N_groups = 6L,
  mean_annual_mei = c(1.3, 1.3, 1.3, 1.3, 1.3, 1.3),
  min_annual_mei = c(0.06, 0.06, 0.06, 0.06, 0.06, 0.06),
  max_annual_mei = c(2.24, 2.24, 2.24, 2.24, 2.24, 2.24),
  sd_annual_mei = c( 0.88125942934994, 0.88125942934994, 0.88125942934994, 0.88125942934994, 0.88125942934994, 0.88125942934994 ),
  kde_shape = c( 42.1272797887948, 15.6010147857965, 16.9838846590234, 25.6636516309937, 9.83374158795608, 14.120254441294 ),
  kde_rate = c( 17.2782121891485, 20.3099755213351, 8.32503886654322, 7.4264895746755, 4.8680436217624, 9.93030086530126 ),
  kde_scale = c( 0.0578763583322609, 0.0492368884910535, 0.120119559323478, 0.134653121093716, 0.205421330969496, 0.100701883413646 ),
  phase_index = c(2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L),
  N_mei = 12L
)

expected_area_list_log <- expected_area_list
expected_area_list_log$group_size <- c(3.2188758248682, 2.77258872223978, 2.77258872223978, 3.04452243772342,  2.56494935746154, 3.13549421592915)

# Test data processing functions ----

expect_equal(construct_main_list(sample_mei_data, sample_group_data), expected_area_list)
expect_equal(calculate_area_log(expected_area_list), expected_area_list_log)
expect_equal(construct_riparian_list(sample_mei_data, sample_group_data, sample_riparian_data), expected_riparian_list)
